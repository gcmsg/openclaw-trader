# P5.3 & P5.4 功能调研报告

> 作者：Mia (openclaw-trader 核心开发)
> 日期：2026-02-25

---

## P5.3 — 清算热力图（Liquidation Heatmap）

### 功能目标

监控市场清算集中区域，识别大量多/空强平订单聚集的价格带。
信号用途：
- 做多时，若上方有密集空头清算 → 上涨阻力减小（看涨）
- 做多时，若下方有密集多头清算 → 支撑薄弱（看跌）

### 数据源评估

#### 1. CoinGlass API（❌ 需要付费 API Key）

```bash
curl -s "https://open-api.coinglass.com/public/v2/liquidation_map?symbol=BTC&timeType=0" \
  -H "accept: application/json"
# → {"code":"40001","msg":"API key required"} 或 401 Unauthorized
```

**结论**：公共端点已下线，需要付费订阅（$29-99/月）。不建议直接依赖。

#### 2. Binance allForceOrders（❌ 历史已清算订单 API 维护中）

```bash
curl "https://fapi.binance.com/fapi/v1/allForceOrders?symbol=BTCUSDT&limit=5"
# → {"code":-4196,"msg":"Feature is under maintenance."}
```

**结论**：API 正在维护，暂不可用。实时清算通知通过 WebSocket 可用（`forceOrder` stream）。

#### 3. Binance Open Interest（✅ 免费，无需 Auth）

```bash
curl "https://fapi.binance.com/futures/data/openInterestHist?symbol=BTCUSDT&period=1h&limit=3"
# → [{"symbol":"BTCUSDT","sumOpenInterest":"69xxx.xx","timestamp":...}]
```

**结论**：持仓量历史（Open Interest）可作为清算热力图的替代指标：
- OI 快速下降 = 大量清算发生
- OI 极高 + 价格拉升 = 空头清算在路上

#### 4. Hyblock Capital / Coinalyze（❌ 付费 API）

提供专业清算热力图服务，但均需 API Key。

### 轻量替代方案：基于 Open Interest 的清算监控（P5.3-Lite）

**实现路径**：

1. 定期拉取 `openInterestHist`（每 15 分钟/1 小时）
2. 计算 OI 变化率：`(newOI - oldOI) / oldOI`
3. 若 OI 变化率 < -5%（急剧下降）且价格同向大幅变动 → 判断为大规模清算
4. 将此信号注入 `indicators.liquidationAlert`，在情绪门控中使用

**示意代码（伪代码）**：
```typescript
const oiData = await getOpenInterestHist("BTCUSDT", "1h", 2);
const oiChange = (oiData[1].sumOI - oiData[0].sumOI) / oiData[0].sumOI;
if (oiChange < -0.05) {
  indicators.liquidationAlert = "long_squeeze"; // 多头被清算
} else if (oiChange > 0.05 && priceUp) {
  indicators.liquidationAlert = "short_squeeze"; // 空头被清算
}
```

**实现估时**：约 2 天（含测试）

**需要主人提供**：无（Binance OI 数据免费）

---

## P5.4 — 社交情绪分析（Social Sentiment）

### 功能目标

通过分析社交媒体（Reddit、Twitter/X、Telegram）的实时情绪，
识别极端看涨/看跌的市场情绪，作为反向或跟随指标。

### 数据源评估

#### 1. Reddit（✅ 免费 JSON API，无需 Key）

```bash
curl -s "https://www.reddit.com/r/CryptoCurrency/search.json?q=bitcoin+crypto&sort=new&limit=3" \
  -H "User-Agent: openclaw-trader/1.0"
# → 正常返回 posts 数组，包含标题、分数、评论数
```

**可用数据**：
- 文章标题（用于关键词匹配）
- 评论数量（热度指标）
- 投票分数（情绪倾向）
- 发帖时间（时效性过滤）

**实现方案（P5.4-Reddit）**：
1. 每 30 分钟爬取 `r/CryptoCurrency`、`r/Bitcoin`、`r/ethtrader` 的最新帖子
2. 计算关键词分数：
   - 利好词（bullish, moon, breakout, long, all-time-high）→ +1
   - 利空词（crash, dump, bear, rug, liquidated）→ -1
3. 综合分数 > +3 = 极度看涨（注意过热）；< -3 = 极度看跌（注意反弹）
4. 接入 `evaluateSentimentGate()` 作为 `sentimentScore` 补充

**限制**：频率需控制（每 30 分钟一次），避免被 rate-limit。

#### 2. LunarCrush（❌ 需要免费/付费 API Key）

```bash
curl "https://lunarcrush.com/api4/public/coins/btc/v1"
# → {"error":"requires_authentication","message":"..."}
```

提供 Galaxy Score（综合社交情绪指数），但需要注册 API Key。
**免费层**：每分钟 60 次请求，基础数据可用。
**需要主人提供**：LunarCrush API Key（免费注册）。

#### 3. Twitter/X API（❌ 付费 API，$100/月 Basic）

X API 基础套餐 $100/月，超出成本预算。

#### 4. Alternative.me Fear & Greed Index（✅ 免费，已集成）

项目中已有 `fear_greed_alert` 配置，该 API 免费且无需 Key。
是最简单的情绪指标，建议继续优化其使用。

### 推荐实施路径

#### Phase 1（无需 API Key）
- 基于 Reddit 的关键词情绪分析（P5.4-Reddit）
- 优化现有 Fear & Greed 信号逻辑
- **实现估时**：约 3 天

#### Phase 2（需要主人提供 Key）
- LunarCrush 集成（提供更专业的 Galaxy Score）
- 需要主人注册 LunarCrush 免费账号：https://lunarcrush.com/register

---

## 建议主人配合的步骤

### 立即可以推进（无需 API Key）
1. **P5.3-Lite**：Binance OI 变化率清算监控 → Mia 直接实现
2. **P5.4-Reddit**：Reddit 关键词情绪分析 → Mia 直接实现

### 需要主人提供 API Key
| 功能 | 服务 | 注册链接 | 费用 |
|------|------|---------|------|
| P5.3 清算热力图 | CoinGlass | https://coinglass.com | $29-99/月 |
| P5.4 社交情绪 | LunarCrush | https://lunarcrush.com/register | 免费套餐可用 |

### 优先级建议
1. 先实现 P5.3-Lite（OI-based）+ P5.4-Reddit（完全免费）
2. 如果主人觉得效果不够，再考虑接入付费数据源
3. LunarCrush 免费注册可以先拿 API Key 备用

---

## 总结

| 功能 | 方案 | 成本 | 实现难度 | 推荐度 |
|------|------|------|---------|--------|
| P5.3 清算热力图 | CoinGlass API | 付费 | 中 | ⭐⭐ |
| P5.3-Lite | Binance OI 监控 | 免费 | 低 | ⭐⭐⭐⭐⭐ |
| P5.4 社交情绪 | Reddit JSON | 免费 | 低 | ⭐⭐⭐⭐ |
| P5.4 社交情绪 | LunarCrush | 免费API Key | 中 | ⭐⭐⭐⭐ |
| P5.4 社交情绪 | Twitter/X API | 付费 | 低 | ⭐ |
